commit ba98bf758e18640c75ab56f0425599125d0f24d9
Author: Euan Russano <euanrussano@gmail.com>
Date:   Sat Jan 31 22:08:35 2026 -0300

    refacotring events (code)

diff --git a/game/core/session.py b/game/core/session.py
index 71d274a..832e6dc 100644
--- a/game/core/session.py
+++ b/game/core/session.py
@@ -118,9 +118,11 @@ class GameSession(IGameSession):
 
     def try_trigger_event(self, x: int, y: int):
         tilemap = self.current_location.tilemap
-        event_tile = tilemap.get_event_tile(x, y)
-        if event_tile.has_event():
-            event_tile.trigger(self)
+        map_event = tilemap.get_map_event(x, y)
+        if not map_event: return
+
+        if map_event.has_event():
+            map_event.trigger(self)
 
             self.view.render(self.current_location, self.hero)
 
diff --git a/game/main.py b/game/main.py
index 1dde413..9e9e77d 100644
--- a/game/main.py
+++ b/game/main.py
@@ -5,7 +5,7 @@ from core.hero import Hero
 from core.itemdefinition import ItemRepository
 from core.session import GameSession, IGameSession
 from graphics.spritesheet import Spritesheet
-from tilemap.event import EventTile
+from tilemap.event import MapEvent
 from tilemap.tilemap import Tile
 from tilemap.tileset import get_tileset
 import config
@@ -116,7 +116,7 @@ class GameScreen(tk.Tk):
         for name, qty in aggregates.items():
             self.inventory_table.insert("", tk.END, values=(name, qty))
 
-    def update_tilemap(self, width: int, height: int, tiles: List[List[Tile]], events: List[List[EventTile]]):
+    def update_tilemap(self, width: int, height: int, tiles: List[List[Tile]], events: List[MapEvent]):
         self.canvas.delete(tk.ALL)
         
         canvas_height = self.canvas.winfo_height()
@@ -126,10 +126,10 @@ class GameScreen(tk.Tk):
                 tile = tiles[i][j]
                 self.draw_tile(tile, i, j)
 
-                # draw event on top
-                event_tile = events[i][j]
-                if event_tile.tile is not None:
-                    self.draw_tile(event_tile.tile, i, j)
+        for event in events:
+            tile = event.tile
+            if tile is not None:
+                self.draw_tile(tile, event.x, event.y)
 
     def draw_tile(self, tile: Tile, world_x: int, world_y: int):
         if tile.id != -1:
diff --git a/game/tilemap/event.py b/game/tilemap/event.py
index d5d1db3..fff86a5 100644
--- a/game/tilemap/event.py
+++ b/game/tilemap/event.py
@@ -7,7 +7,7 @@ from tilemap.tile_ids import TileID
 
 class Event(ABC):
     def __init__(self):
-        self.owner: Optional['EventTile'] = None
+        self.owner: Optional['MapEvent'] = None
     @abstractmethod
     def trigger(self, session):
         pass
@@ -117,8 +117,10 @@ class IfEvent(Event):
             self.else_event.trigger(session)
 
 
-class EventTile:
-    def __init__(self, tile: Optional[Tile] = None, event: Optional[Event] = None, run_once:bool=True):
+class MapEvent:
+    def __init__(self, x: int, y: int, tile: Optional[Tile] = None, event: Optional[Event] = None, run_once:bool=True):
+        self.x = x
+        self.y = y
         self.tile = tile
         self.__event = None
         self.run_once = run_once
diff --git a/game/tilemap/tilemap.py b/game/tilemap/tilemap.py
index e16cfe6..dad7e46 100644
--- a/game/tilemap/tilemap.py
+++ b/game/tilemap/tilemap.py
@@ -3,7 +3,7 @@ from typing import List
 import random
 
 from core.itemdefinition import ItemRepository
-from tilemap.event import ChangeTileEvent, CompositeEvent, EventTile, GiveGoldEvent, ShowMessageEvent, AddItemEvent, \
+from tilemap.event import ChangeTileEvent, CompositeEvent, MapEvent, GiveGoldEvent, ShowMessageEvent, AddItemEvent, \
     IfEvent, HasItemCondition, DeactivateEvent, RemoveItemEvent
 
 from .tile_ids import TREES, TileID
@@ -25,16 +25,6 @@ class TilemapFactory(ABC):
             tiles.append(row)
         return tiles
 
-    @staticmethod
-    def create_empty_events(width: int, height: int) -> List[List['EventTile']]:
-        events = []
-        for _ in range(width):    
-            row = []
-            for _ in range(height):
-                row.append(EventTile())
-            events.append(row)
-        return events
-
 class ForestTilemapFactory(TilemapFactory):
     def create(self, place_random_chests:bool = False, place_sign:bool = False, place_key:bool = False) -> 'Tilemap':
         
@@ -44,7 +34,7 @@ class ForestTilemapFactory(TilemapFactory):
         height = 10
         tileset: Tileset = get_tileset()
         tiles = []
-        events = TilemapFactory.create_empty_events(width, height)
+        events = []
         for i in range(width):    
             row = []
             for j in range(height):
@@ -54,20 +44,23 @@ class ForestTilemapFactory(TilemapFactory):
                 elif place_random_chests:
                     if random.random() < 0.1:
                         gold_amount = random.randint(1, 3)
-                        events[i][j].tile = tileset.get_tile(TileID.CHEST_CLOSED)
                         event = CompositeEvent([
                             ShowMessageEvent("You found a chest!"),
                             GiveGoldEvent(gold_amount),
                             ShowMessageEvent(f"You got {gold_amount} gold"),
                             ChangeTileEvent(tileset.get_tile(TileID.EMPTY)),
-                        ])  
-                        events[i][j].set_event(event)
+                        ])
+                        map_event = MapEvent(i, j, tileset.get_tile(TileID.CHEST_CLOSED))
+                        map_event.set_event(event)
+                        events.append(map_event)
                 elif place_sign:
                     if random.random() < 0.1:
-                        events[i][j].run_once = False
-                        events[i][j].tile = tileset.get_tile(TileID.SIGN)
+                        map_event = MapEvent(i, j)
+                        map_event.run_once = False
+                        map_event.tile = tileset.get_tile(TileID.SIGN)
                         event = ShowMessageEvent("You found a sign!")
-                        events[i][j].set_event(event)
+                        map_event.set_event(event)
+                        events.append(map_event)
                         # only place max one sign
                         place_sign = False
                 
@@ -85,13 +78,15 @@ class ForestTilemapFactory(TilemapFactory):
                 x = random.randint(0, width-1)
                 y = random.randint(0, height-1)
                 if tiles[x][y].id == TileID.EMPTY:
-                    events[x][y].tile = tileset.get_tile(TileID.KEY)
+                    map_event = MapEvent(x, y)
+                    map_event.tile = tileset.get_tile(TileID.KEY)
                     event = CompositeEvent([
                         ShowMessageEvent("You found a key!"),
                         ChangeTileEvent(tileset.get_tile(TileID.EMPTY)),
                         AddItemEvent(ItemRepository.get_instance().find_by_id(TileID.KEY))
                     ])
-                    events[x][y].set_event(event)
+                    map_event.set_event(event)
+                    events.append(map_event)
                     is_key_placed = True
         return Tilemap(tiles, events)
 
@@ -110,13 +105,10 @@ class TownTilemapFactory(TilemapFactory):
         events = []
         for _ in range(10):    
             row = []
-            event_row = []
             for _ in range(10):
                 id = TileID.EMPTY
                 row.append(tileset.get_tile(id))
-                event_row.append(EventTile())
             tiles.append(row)
-            events.append(event_row)
         
         # create 4 buildings
         self.create_building(tiles, events, 2, 2, 4, 4, door_type=DoorType.SIMPLE)
@@ -127,7 +119,7 @@ class TownTilemapFactory(TilemapFactory):
     
         return Tilemap(tiles, events)
     
-    def create_building(self, tiles: List[List['Tile']], events: List[List['EventTile']], x: int, y: int, width: int, height: int, door_type: DoorType = DoorType.CLOSED):
+    def create_building(self, tiles: List[List['Tile']], events: List['MapEvent'], x: int, y: int, width: int, height: int, door_type: DoorType = DoorType.CLOSED):
         """
         Create a building with y-axis pointing up
         (x, y) is the bottom-left corner of the building
@@ -152,12 +144,14 @@ class TownTilemapFactory(TilemapFactory):
         # Door on the bottom wall
         if door_type == DoorType.SIMPLE:
             tiles[x+1][y] = tileset.get_tile(TileID.EMPTY)
-            events[x+1][y].tile = tileset.get_tile(TileID.BUILDING_DOOR_CLOSED)
+            map_event = MapEvent(x+1, y)
+            map_event.tile = tileset.get_tile(TileID.BUILDING_DOOR_CLOSED)
             event = CompositeEvent([
                 ChangeTileEvent(tileset.get_tile(TileID.BUILDING_DOOR_OPEN)),
                 ShowMessageEvent("You opened the door")
             ])
-            events[x+1][y].set_event(event)
+            map_event.set_event(event)
+            events.append(map_event)
         elif door_type == DoorType.CLOSED:
             id = TileID.BUILDING_DOOR_CLOSED
             tiles[x+1][y] = tileset.get_tile(id)
@@ -166,7 +160,8 @@ class TownTilemapFactory(TilemapFactory):
             tiles[x + 1][y] = tileset.get_tile(id)
         elif door_type == DoorType.LOCKED:
             tiles[x + 1][y] = tileset.get_tile(TileID.EMPTY)
-            events[x + 1][y].tile = tileset.get_tile(TileID.BUILDING_DOOR_CLOSED)
+            map_event = MapEvent(x+1, y)
+            map_event.tile = tileset.get_tile(TileID.BUILDING_DOOR_CLOSED)
             event = IfEvent(
                 condition=HasItemCondition(TileID.KEY),
                 then_event=CompositeEvent([
@@ -178,8 +173,9 @@ class TownTilemapFactory(TilemapFactory):
                 else_event=ShowMessageEvent("The door is locked.")
             )
 
-            events[x+1][y].set_event(event)
-            events[x+1][y].run_once = False
+            map_event.set_event(event)
+            map_event.run_once = False
+            events.append(map_event)
         
         # Window on the bottom wall if there's room
         if x+2 < x+width:
@@ -201,16 +197,12 @@ class TilemapLoader:
         return Tilemap(tiles)
 
 class Tilemap:
-    def __init__(self, tiles: List[List[Tile]], events: List[List[EventTile]] | None = None):
+    def __init__(self, tiles: List[List[Tile]], events: List[MapEvent] = ()):
         self.tiles = tiles
         self.width = len(tiles)
         self.height = len(tiles[0])
 
-        if events is None:
-            self.events = [[EventTile() for _ in range(self.height)] for _ in range(self.width)]
-        else:
-            assert(len(events) == self.width and len(events[0]) == self.height)
-            self.events = events
+        self.events = events
 
     def has_tile(self, x: int, y: int):
         return x >= 0 and x < self.width and y >= 0 and y < self.height
@@ -220,16 +212,18 @@ class Tilemap:
             return Tile(TileID.EMPTY)
         return self.tiles[x][y]
     
-    def get_event_tile(self, x: int, y: int):
+    def get_map_event(self, x: int, y: int) -> MapEvent | None:
         if not self.has_tile(x, y): 
-            return EventTile()
-        return self.events[x][y]
+            return None
+        map_event = next((map_event for map_event in self.events if map_event.x == x and map_event.y == y), None)
+        return map_event
     
     def is_blocked(self, new_x: int, new_y: int):
         if not self.has_tile(new_x, new_y): 
             return True
         if not self.get_tile(new_x, new_y).is_walkable: 
             return True
-        if not self.events[new_x][new_y].is_walkable:
+        map_event = self.get_map_event(new_x, new_y)
+        if map_event and not map_event.is_walkable:
             return True
         return False
\ No newline at end of file
